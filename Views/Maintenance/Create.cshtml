@model AutoPartsPOS.Models.Maintenances.Maintenance
@section Styles {
    <link rel="stylesheet" href="~/css/site1.css" asp-append-version="true" />
}
@{
    ViewData["Title"] = "Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯Ø©";
}

<div class="container mt-4">
    <h2 class="text-right">ğŸ›  Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© ØµÙŠØ§Ù†Ø©</h2>
    <hr />

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show text-right" role="alert">
            <strong>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</strong> @TempData["Error"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show text-right" role="alert">
            @TempData["Success"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    <form id="maintenanceForm" asp-action="Create" method="post">
        @Html.AntiForgeryToken()
        
        <div class="row">
            <div class="col-md-4">
                <div class="card shadow-sm mb-4 border-primary">
                    <div class="card-header bg-primary text-white font-weight-bold">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
                            <input asp-for="Name" class="form-control" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØµÙŠØ§Ù†Ø© Ø¯ÙˆØ±ÙŠØ© Ù„Ø³ÙŠØ§Ø±Ø© ØªÙˆÙŠÙˆØªØ§" required />
                        </div>
                        <div class="form-group">
                            <label>Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©</label>
                            <select asp-for="Type" class="form-control" asp-items="Html.GetEnumSelectList<AutoPartsPOS.Models.Maintenances.MaintenanceType>()"></select>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                            <select asp-for="CustomerId" id="CustomerId" class="form-control select2" required>
                                <option value="">-- Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ --</option>
                                @foreach (var c in ViewBag.Customers) {
                                    <option value="@c.Id">@c.Name (Ø±ØµÙŠØ¯Ù‡: @c.Balance)</option>
                                }
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
                            <select asp-for="TechnicianId" class="form-control" required>
                                <option value="">-- Ø§Ø®ØªØ± ÙÙ†ÙŠ --</option>
                                @foreach (var u in ViewBag.Technicians) {
                                    <option value="@u.Id">@u.FullName</option>
                                }
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ø³Ø¹Ø± Ø§Ù„Ù…ØµÙ†Ø¹ÙŠØ© (Ø§Ù„ÙŠØ¯)</label>
                            <input asp-for="ServicePrice" id="servicePrice" type="number" step="0.01" class="form-control" value="0" />
                        </div>
                    </div>
                </div>

                <div class="card border-warning mb-3 shadow-sm">
                    <div class="card-header bg-warning font-weight-bold">ğŸ“¦ ØªØ³Ø¬ÙŠÙ„ Ø£Ù…Ø§Ù†Ø§Øª (Ù‚Ø·Ø¹ Ù…Ø­ØªØ¬Ø²Ø©)</div>
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <input type="text" id="holdItemName" class="form-control" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…ÙØªØ§Ø­ Ø§Ù„Ø³ÙŠØ§Ø±Ø©..">
                            <div class="input-group-append">
                                <button class="btn btn-warning" type="button" id="btnAddHoldItem">Ø¥Ø¶Ø§ÙØ©</button>
                            </div>
                        </div>
                        <ul id="holdItemsList" class="list-group list-group-flush"></ul>
                        <input type="hidden" name="holdItemsJson" id="holdItemsJson" />
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card shadow-sm mb-4 border-success">
                    <div class="card-header bg-success text-white font-weight-bold">Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©</div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <select id="productSelect" class="form-control select2">
                                    <option value="">-- Ø§Ø®ØªØ± Ù‚Ø·Ø¹Ø© ØºÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù† --</option>
                                    @foreach (var p in ViewBag.Products) {
                                        <option value="@p.Id" data-price="@p.SellPrice" data-stock="@p.Quantity">@p.Name (Ø§Ù„Ù…ØªØ§Ø­: @p.Quantity)</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="number" id="productQty" class="form-control" value="1" min="1" />
                            </div>
                            <div class="col-md-3">
                                <button type="button" id="btnAddProduct" class="btn btn-success btn-block font-weight-bold">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¬Ø¯ÙˆÙ„</button>
                            </div>
                        </div>

                        <table class="table table-bordered text-center" id="itemsTable">
                            <thead class="bg-light">
                                <tr>
                                    <th class="text-right">Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th>Ø§Ù„Ø³Ø¹Ø±</th>
                                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                    <th>Ø­Ø°Ù</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="3" class="text-left font-weight-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±:</th>
                                    <th id="partsTotal">0.00</th>
                                    <th></th>
                                </tr>
                                <tr class="bg-dark text-white">
                                    <th colspan="3" class="text-left font-weight-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</th>
                                    <th id="finalTotal">0.00</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <input type="hidden" name="itemsJson" id="itemsJson" />
                <button type="submit" id="btnSubmitForm" class="btn btn-primary btn-lg float-left shadow-lg">Ø­ÙØ¸ ÙˆØ¥ØµØ¯Ø§Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø© âœ…</button>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        var $j = jQuery.noConflict();

        $j(document).ready(function () {
            let selectedItems = [];
            let holdItemsArray = [];

            // --- 1. Ù…Ù†Ø·Ù‚ Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± ---
            $j('#btnAddProduct').click(function (e) {
                e.preventDefault();
                let pId = $j('#productSelect').val();
                let pSelect = $j('#productSelect option:selected');
                let pName = pSelect.text();
                let pPrice = parseFloat(pSelect.attr('data-price')) || 0;
                let pStock = parseInt(pSelect.attr('data-stock')) || 0;
                let qty = parseInt($j('#productQty').val()) || 0;

                if (!pId || qty <= 0) return alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ ÙˆÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©");
                if (qty > pStock) return alert("Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªØ§Ø­ Ø¨Ø§Ù„Ù…Ø®Ø²Ù†! Ø§Ù„Ù…ØªØ§Ø­: " + pStock);

                selectedItems.push({ 
                    ProductId: parseInt(pId), 
                    Name: pName, 
                    Price: pPrice, 
                    Quantity: qty 
                });

                renderPartsTable();
                $j('#productSelect').val('').trigger('change');
            });

            function renderPartsTable() {
                let html = '';
                let partsTotal = 0;
                $j.each(selectedItems, function(index, item) {
                    let rowTotal = item.Price * item.Quantity;
                    partsTotal += rowTotal;
                    html += `<tr>
                                <td class="text-right">${item.Name}</td>
                                <td>${item.Price.toFixed(2)}</td>
                                <td>${item.Quantity}</td>
                                <td>${rowTotal.toFixed(2)}</td>
                                <td><button type="button" class="btn btn-danger btn-sm" onclick="removePart(${index})">Ø­Ø°Ù</button></td>
                             </tr>`;
                });
                $j('#itemsTable tbody').html(html);
                $j('#partsTotal').text(partsTotal.toFixed(2));
                $j('#itemsJson').val(JSON.stringify(selectedItems));
                calculateFinalTotal();
            }

            window.removePart = function(index) {
                selectedItems.splice(index, 1);
                renderPartsTable();
            };

            // --- 2. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ù…Ø§Ù†Ø§Øª (Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø­ØªØ¬Ø²Ø©) ---
            $j('#btnAddHoldItem').click(function() {
                let name = $j('#holdItemName').val().trim();
                if(name == "") return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø£Ù…Ø§Ù†Ø© Ø£ÙˆÙ„Ø§Ù‹");

                holdItemsArray.push(name);
                renderHoldList();
                $j('#holdItemName').val("").focus();
            });

            function renderHoldList() {
                let listHtml = "";
                holdItemsArray.forEach((item, index) => {
                    listHtml += `<li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                                    ${item}
                                    <span class="badge badge-danger badge-pill" style="cursor:pointer" onclick="removeHold(${index})">Ø­Ø°Ù</span>
                                 </li>`;
                });
                $j('#holdItemsList').html(listHtml);
                $j('#holdItemsJson').val(JSON.stringify(holdItemsArray));
            }

            window.removeHold = function(index) {
                holdItemsArray.splice(index, 1);
                renderHoldList();
            };

            // --- 3. Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ---
            function calculateFinalTotal() {
                let partsTotal = parseFloat($j('#partsTotal').text()) || 0;
                let servicePrice = parseFloat($j('#servicePrice').val()) || 0;
                let final = partsTotal + servicePrice;
                $j('#finalTotal').text(final.toFixed(2));
            }

            $j('#servicePrice').on('input', calculateFinalTotal);

            // --- 4. Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø£Ù…Ø§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©) ---
            $j('#CustomerId').change(function() {
                let customerId = $j(this).val();
                if(!customerId) return;

                $j.get('/Maintenance/GetCustomerHoldItems?customerId=' + customerId, function(data) {
                    if(data && data.length > 0) {
                        alert("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø¯ÙŠÙ‡ Ø£Ù…Ø§Ù†Ø§Øª Ù…Ø­ØªØ¬Ø²Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹:\n" + data.join('\n'));
                    }
                });
            });

            // --- 5. Ø§Ù„ØªØ­Ù‚Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸ ---
            $j('#maintenanceForm').submit(function() {
                if (selectedItems.length === 0 && (parseFloat($j('#servicePrice').val()) || 0) <= 0) {
                    alert("ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹ ØºÙŠØ§Ø± Ø£Ùˆ Ø³Ø¹Ø± Ù…ØµÙ†Ø¹ÙŠØ© Ù„Ù„Ø­ÙØ¸");
                    return false;
                }
            });
        });
    </script>
}