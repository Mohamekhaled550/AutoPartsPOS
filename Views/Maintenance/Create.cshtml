@model AutoPartsPOS.Models.Maintenances.Maintenance

@{
    ViewData["Title"] = "ุฅุถุงูุฉ ุนูููุฉ ุตูุงูุฉ ุฌุฏูุฏุฉ";
}

<div class="container mt-4">
    <h2 class="text-right">๐ ุฅุถุงูุฉ ุนูููุฉ ุตูุงูุฉ</h2>
    <hr />
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show text-right" role="alert">
        <strong>ุฎุทุฃ ูู ุงูุนูููุฉ:</strong> @TempData["Error"]
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show text-right" role="alert">
        @TempData["Success"]
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}


    <form id="maintenanceForm" asp-action="Create" method="post">
        @Html.AntiForgeryToken()
        
        <div class="row">
            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ</div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>ุงุณู ุงูุนูููุฉ</label>
                            <input asp-for="Name" class="form-control" placeholder="ูุซูุงู: ุตูุงูุฉ ุฏูุฑูุฉ ูุณูุงุฑุฉ ุชูููุชุง" required />
                        </div>
                        <div class="form-group">
                            <label>ููุน ุงูุตูุงูุฉ</label>
                            <select asp-for="Type" class="form-control" asp-items="Html.GetEnumSelectList<AutoPartsPOS.Models.Maintenances.MaintenanceType>()"></select>
                        </div>
                        <div class="form-group">
                            <label>ุงูุนููู</label>
                            <select asp-for="CustomerId" class="form-control select2" required>
                                <option value="">-- ุงุฎุชุฑ ุนููู --</option>
                                @foreach (var c in ViewBag.Customers) {
                                    <option value="@c.Id">@c.Name (ุฑุตูุฏู: @c.Balance)</option>
                                }
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ุงูููู ุงููุณุคูู</label>
                            <select asp-for="TechnicianId" class="form-control" required>
                                <option value="">-- ุงุฎุชุฑ ููู --</option>
                                @foreach (var u in ViewBag.Technicians) {
                                    <option value="@u.Id">@u.FullName</option>
                                }
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ุณุนุฑ ุงููุตูุนูุฉ (ุงููุฏ)</label>
                            <input asp-for="ServicePrice" id="servicePrice" type="number" step="0.01" class="form-control total-trigger" value="0" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">ูุทุน ุงูุบูุงุฑ ุงููุณุชูููุฉ</div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <select id="productSelect" class="form-control select2">
                                    <option value="">-- ุงุฎุชุฑ ูุทุนุฉ ุบูุงุฑ ูู ุงููุฎุฒู --</option>
                                    @foreach (var p in ViewBag.Products) {
                                        <option value="@p.Id" data-price="@p.SellPrice" data-stock="@p.Quantity">@p.Name (ุงููุชุงุญ: @p.Quantity)</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="number" id="productQty" class="form-control" value="1" min="1" />
                            </div>
                            <div class="col-md-3">
                                <button type="button" id="btnAddProduct" class="btn btn-success btn-block">ุฅุถุงูุฉ ููุฌุฏูู</button>
                            </div>
                        </div>

<div class="card shadow-sm mb-4 border-warning">
    <div class="card-header bg-warning text-dark font-weight-bold">โ๏ธ ุฃุตูุงู ูุญุชุฌุฒุฉ ุชุญุช ุงูุฅุตูุงุญ (ุฃูุงูุงุช)</div>
    <div class="card-body">
        <div class="row mb-2">
            <div class="col-md-9">
                <input type="text" id="holdItemName" class="form-control" placeholder="ูุซูุงู: ููุชุงุญ ุงูุณูุงุฑุฉุ ุฅุทุงุฑ ูุฏููุ ุจุทุงุฑูุฉ..." />
            </div>
            <div class="col-md-3">
                <button type="button" id="btnAddHoldItem" class="btn btn-warning btn-block font-weight-bold">ุฅุถุงูุฉ ุฃูุงูุฉ</button>
            </div>
        </div>
        <ul id="holdItemsList" class="list-group list-group-flush">
            </ul>
        <input type="hidden" name="holdItemsJson" id="holdItemsJson" />
    </div>
</div>

                        <table class="table table-bordered" id="itemsTable">
                            <thead class="bg-light">
                                <tr>
                                    <th>ุงูููุชุฌ</th>
                                    <th>ุงูุณุนุฑ</th>
                                    <th>ุงููููุฉ</th>
                                    <th>ุงูุฅุฌูุงูู</th>
                                    <th>ุญุฐู</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="3" class="text-left">ุฅุฌูุงูู ูุทุน ุงูุบูุงุฑ:</th>
                                    <th id="partsTotal">0.00</th>
                                    <th></th>
                                </tr>
                                <tr class="bg-dark text-white">
                                    <th colspan="3" class="text-left">ุฅุฌูุงูู ุงููุงุชูุฑุฉ ุงูููุงุฆู:</th>
                                    <th id="finalTotal">0.00</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <input type="hidden" name="itemsJson" id="itemsJson" />
                <button type="submit" class="btn btn-primary btn-lg float-left">ุญูุธ ูุฅุตุฏุงุฑ ุงููุงุชูุฑุฉ</button>
            </div>
        </div>
    </form>
</div>
@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // ุงุณุชุฎุฏุงู jQuery.noConflict ูุถูุงู ุนุฏู ูุฌูุฏ ุชุฏุงุฎู
        var $j = jQuery.noConflict();

        $j(document).ready(function () {
            console.log("ุงูุณูุฑุจุช ุงุดุชุบู ุชูุงู"); // ุงูุชุญ F12 ูุดูู ุงููููุฉ ุฏู ุธูุฑุช ููุง ูุง

            let selectedItems = [];

            // 1. ุฅุถุงูุฉ ููุชุฌ ููุฌุฏูู
            $j('#btnAddProduct').click(function (e) {
                e.preventDefault();

                let pId = $j('#productSelect').val();
                let pSelect = $j('#productSelect option:selected');
                let pName = pSelect.text();
                let pPrice = parseFloat(pSelect.attr('data-price')) || 0;
                let pStock = parseInt(pSelect.attr('data-stock')) || 0;
                let qty = parseInt($j('#productQty').val()) || 0;

                console.log("ุจูุงูุงุช ุงูููุชุฌ ุงููุฎุชุงุฑ:", { pId, pPrice, pStock, qty });

                if (!pId || qty <= 0) {
                    alert("ุฑุฌุงุกู ุงุฎุชุฑ ููุชุฌ ููููุฉ ุตุญูุญุฉ");
                    return;
                }

                if (qty > pStock) {
                    alert("ุงููููุฉ ุงููุทููุจุฉ ุฃูุจุฑ ูู ุงููุชุงุญ ุจุงููุฎุฒู! ุงููุชุงุญ: " + pStock);
                    return;
                }

                // ุฅุถุงูุฉ ูููุตูููุฉ
                selectedItems.push({ 
                    ProductId: parseInt(pId), 
                    Name: pName, 
                    Price: pPrice, 
                    Quantity: qty 
                });

                renderTable();
            });

            // 2. ุฑุณู ุงูุฌุฏูู
            function renderTable() {
                let html = '';
                let partsTotal = 0;

                $j.each(selectedItems, function(index, item) {
                    let rowTotal = item.Price * item.Quantity;
                    partsTotal += rowTotal;
                    html += `<tr>
                                <td class="text-right">${item.Name}</td>
                                <td>${item.Price.toFixed(2)}</td>
                                <td>${item.Quantity}</td>
                                <td>${rowTotal.toFixed(2)}</td>
                                <td><button type="button" class="btn btn-danger btn-sm btn-remove" data-index="${index}">ุญุฐู</button></td>
                             </tr>`;
                });

                $j('#itemsTable tbody').html(html);
                $j('#partsTotal').text(partsTotal.toFixed(2));
                
                // ุชุญุฏูุซ ุงูุญูู ุงููุฎูู
                $j('#itemsJson').val(JSON.stringify(selectedItems));
                
                calculateFinalTotal();
            }

            // 3. ุญุฐู ุนูุตุฑ
            $j(document).on('click', '.btn-remove', function() {
                let index = $j(this).data('index');
                selectedItems.splice(index, 1);
                renderTable();
            });

            // 4. ุญุณุงุจ ุงูุฅุฌูุงูู ุงูููุงุฆู
            function calculateFinalTotal() {
                let partsTotal = parseFloat($j('#partsTotal').text()) || 0;
                let servicePrice = parseFloat($j('#servicePrice').val()) || 0;
                let final = partsTotal + servicePrice;
                $j('#finalTotal').text(final.toFixed(2));
            }

            $j('#servicePrice').on('input', function() {
                calculateFinalTotal();
            });
        });

        // ูุตูููุฉ ููุฃุตูุงู ุงููุญุชุฌุฒุฉ ุงูุฌุฏูุฏุฉ
let holdItems = [];

// ุฅุถุงูุฉ ุฃูุงูุฉ ููุณุชุฉ
$('#btnAddHoldItem').click(function() {
    let itemName = $('#holdItemName').val();
    if(!itemName) return;
    holdItems.push(itemName);
    renderHoldList();
    $('#holdItemName').val('');
});

function renderHoldList() {
    let html = '';
    holdItems.forEach((item, index) => {
        html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    ${item}
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeHoldItem(${index})">ร</button>
                 </li>`;
    });
    $('#holdItemsList').html(html);
    $('#holdItemsJson').val(JSON.stringify(holdItems));
}

function removeHoldItem(index) {
    holdItems.splice(index, 1);
    renderHoldList();
}

// --- ุงูุชูุจูู ุงูุชููุงุฆู ุนูุฏ ุงุฎุชูุงุฑ ุงูุนููู ---
$('#CustomerId').change(function() {
    let customerId = $(this).val();
    if(!customerId) return;

    // ุทูุจ Ajax ููุชุฃูุฏ ูู ูุฌูุฏ ุฃูุงูุงุช ูุฏููุฉ
    $.get('/Maintenance/GetCustomerHoldItems?customerId=' + customerId, function(data) {
        if(data && data.length > 0) {
            let itemsStr = data.join(' - ');
            Swal.fire({ // ุงุณุชุฎุฏู SweetAlert2 ูู ุนูุฏู ุฃู alert ุนุงุฏูุฉ
                title: 'โ๏ธ ุชูุจูู: ุงูุนููู ูุฏูู ุฃูุงูุงุช!',
                text: 'ุงูุฃุตูุงู ุงููุญุชุฌุฒุฉ ุณุงุจูุงู: ' + itemsStr,
                icon: 'warning',
                confirmButtonText: 'ุชูุงู'
            });
        }
    });
});
    </script>

    
}