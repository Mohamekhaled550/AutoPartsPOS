@model AutoPartsPOS.Models.SalesInvoice
@{
    ViewData["Title"] = "نقطة البيع";
    var products = ViewBag.Products as List<AutoPartsPOS.Models.Product>;
    var customers = ViewBag.Customers as List<AutoPartsPOS.Models.Customer>;
}

<style>
    /* 1. التنسيق الأساسي للحاويات */
    .pos-container {
        max-width: 100%;
        margin: 0 auto;
        padding: 10px;
    }

    .pos-wrapper {
        display: flex;
        gap: 20px;
        height: calc(100vh - 180px);
        align-items: stretch;
    }

    /* 2. القسم الأيمن (المنتجات) */
    .pos-main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 15px;
        min-width: 0;
    }

    .pos-categories-bar {
        display: flex;
        gap: 8px;
        background: white;
        padding: 10px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .category-btn {
        padding: 6px 15px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        background: #f8fafc;
        cursor: pointer;
        font-weight: 600;
    }

    .category-btn.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 12px;
        overflow-y: auto;
        padding: 5px;
        flex: 1;
    }

    .product-item-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        height: 110px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        position: relative;
        transition: 0.2s;
        text-align: center;
        padding: 10px;
    }

    .product-item-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border-color: #3b82f6;
    }

    .price-tag {
        position: absolute;
        top: 5px;
        left: 5px;
        background: #10b981;
        color: white;
        padding: 2px 6px;
        border-radius: 5px;
        font-size: 11px;
        font-weight: bold;
    }

    /* 3. القسم الأيسر (الفاتورة) */
    .pos-invoice-panel {
        width: 380px;
        background: white;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
        padding: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .invoice-scroll {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 15px;
        border-bottom: 1px dashed #cbd5e1;
    }

    .data-table-pos {
        width: 100%;
        font-size: 13px;
    }

    .data-table-pos thead th {
        position: sticky;
        top: 0;
        background: #f8fafc;
        padding: 8px;
        border-bottom: 2px solid #e2e8f0;
    }

    .invoice-item-row td {
        padding: 8px;
        border-bottom: 1px solid #f1f5f9;
    }

    .total-display {
        background: #1e293b;
        color: white;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 15px;
    }

    /* 4. الإشعارات */
    .pos-alert-box {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
    }

    /* تحسين شكل المدخلات */
    .form-control-sm, .form-select-sm {
        margin-bottom: 8px;
        border-radius: 6px;
    }
</style>

<div class="pos-container">
    <div class="pos-alert-box">
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show shadow">
                <i class="fas fa-check-circle"></i> @TempData["Success"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show shadow">
                <i class="fas fa-exclamation-triangle"></i> @TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }
    </div>

    <h2 style="font-weight: 800; color: #1e293b; margin-bottom: 15px;">
        نقطة البيع <i class="fas fa-cash-register text-primary"></i>
    </h2>

    <form asp-action="Create" method="post" id="posForm">
        @Html.AntiForgeryToken()
        <input type="hidden" name="invoiceItemsJson" id="invoiceItemsJson" />

        <div class="pos-wrapper">
            <div class="pos-main-content">
                <div class="pos-categories-bar">
                    <button type="button" class="category-btn active" data-type="All">الكل</button>
                    <button type="button" class="category-btn" data-type="Original">أصلي</button>
                    <button type="button" class="category-btn" data-type="Commercial">تجاري</button>
                    <button type="button" class="category-btn" data-type="Chinese">صيني</button>
                </div>

                <div class="products-grid">
                    @foreach (var p in products)
                    {
                        <div class="product-item-card add-item"
                             data-id="@p.Id"
                             data-name="@p.Name"
                             data-price="@p.SellPrice"
                             data-type="@p.Type">
                            <span class="price-tag">@p.SellPrice.ToString("N0")</span>
                            <span class="product-name" style="font-weight: 600; font-size: 13px;">@p.Name</span>
                        </div>
                    }
                </div>
            </div>

            <div class="pos-invoice-panel">
                <h5 style="font-weight: 700; margin-bottom: 10px;">
                    <i class="fas fa-shopping-cart"></i> السلة
                </h5>

                <div class="invoice-scroll">
                    <table class="data-table-pos" id="invoiceItemsTable">
                        <thead>
                            <tr>
                                <th>الصنف</th>
                                <th width="50">كمية</th>
                                <th>سعر</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>

                <div class="total-display">
                    <div style="font-size: 12px; opacity: 0.8;">المجموع النهائي</div>
                    <div style="font-size: 28px; font-weight: 800; color: #10b981;">
                        <span id="totalAmountVal">0.00</span> <small style="font-size: 14px;">ج.م</small>
                    </div>
                </div>

                <div class="controls-section" style="background: #f1f5f9; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                    <label style="font-size: 12px; font-weight: bold;">طريقة الدفع</label>
                    <select name="IsCredit" id="invoiceType" class="form-select form-select-sm">
                        <option value="false">نقدي (Cash)</option>
                        <option value="true">آجل (Credit)</option>
                    </select>

                    <input type="hidden" name="CustomerId" value="3" id="defaultCustomerId" />

                    <div id="customerSelectDiv" style="display:none; margin-top: 5px;">
                        <label style="font-size: 12px; font-weight: bold;">العميل</label>
                        <select name="CustomerId" class="form-select form-select-sm">
                            <option value="">-- اختر العميل --</option>
                            @foreach (var c in customers)
                            {
                                <option value="@c.Id">@c.Name</option>
                            }
                        </select>
                    </div>
                </div>

                <button type="submit" class="btn btn-success w-100" style="padding: 12px; font-weight: bold; border-radius: 10px;">
                    <i class="fas fa-save"></i> حفظ وإتمام العملية
                </button>
            </div>
        </div>
    </form>
</div>

@section Scripts{
<script>
    let invoiceItems = [];

    function renderTable() {
        const tbody = document.querySelector("#invoiceItemsTable tbody");
        const totalSpan = document.getElementById("totalAmountVal");
        tbody.innerHTML = "";
        let total = 0;

        invoiceItems.forEach((item, idx) => {
            let rowTotal = item.price * item.quantity;
            total += rowTotal;

            tbody.innerHTML += `
                <tr class="invoice-item-row">
                    <td>${item.name}</td>
                    <td>
                        <input type="number" value="${item.quantity}" min="1" 
                               onchange="updateQty(${idx}, this.value)" 
                               style="width: 45px; border: 1px solid #ddd; text-align: center;">
                    </td>
                    <td style="font-weight: bold;">${rowTotal.toFixed(2)}</td>
                    <td>
                        <button type="button" onclick="removeItem(${idx})" style="color:red; border:none; background:none; cursor:pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
        });

        totalSpan.innerText = total.toFixed(2);
        
        // تجهيز الـ JSON للإرسال للكنترولر
        document.getElementById("invoiceItemsJson").value = JSON.stringify(
            invoiceItems.map(x => ({ ProductId: x.ProductId, Quantity: x.quantity }))
        );
    }

    function updateQty(idx, val) {
        if(val < 1) val = 1;
        invoiceItems[idx].quantity = parseInt(val);
        renderTable();
    }

    function removeItem(idx) {
        invoiceItems.splice(idx, 1);
        renderTable();
    }

    // إضافة صنف عند الضغط على الكارت
    document.querySelectorAll(".add-item").forEach(card => {
        card.addEventListener("click", () => {
            const id = parseInt(card.dataset.id);
            const name = card.dataset.name;
            const price = parseFloat(card.dataset.price);

            const exist = invoiceItems.find(x => x.ProductId === id);
            if (exist) {
                exist.quantity++;
            } else {
                invoiceItems.push({ ProductId: id, name: name, price: price, quantity: 1 });
            }
            renderTable();
        });
    });

    // تبديل نوع الدفع
    document.getElementById("invoiceType").addEventListener("change", function () {
        const isCredit = this.value === "true";
        document.getElementById("customerSelectDiv").style.display = isCredit ? "block" : "none";
        document.getElementById("defaultCustomerId").disabled = isCredit;
    });

    // فلترة الأقسام
    document.querySelectorAll(".category-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            const type = btn.dataset.type;
            document.querySelectorAll(".product-item-card").forEach(card => {
                card.style.display = (type === "All" || card.dataset.type === type) ? "flex" : "none";
            });
        });
    });
</script>
}