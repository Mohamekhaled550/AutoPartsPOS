@model dynamic 
@{
    var customer = ViewBag.Customer;
    var invoices = ViewBag.Invoices as IEnumerable<dynamic>;
    var collections = ViewBag.Collections as IEnumerable<dynamic>;
}

<style>
    /* 1. إعدادات الطباعة - إخفاء الناف بار وأي عناصر غير ضرورية */
    @@media print {
        /* إخفاء الناف بار، الفوتر، وأزرار التحكم */
        nav, .navbar, header, footer, .btn-controls, .d-print-none, aside, .sidebar {
            display: none !important;
            height: 0 !important;
        }

        body {
            background-color: white !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .statement-container {
            box-shadow: none !important;
            border: none !important;
            width: 100% !important;
            max-width: 100% !important;
            padding: 10px !important;
        }

        /* لضمان طباعة الألوان الخلفية للكروت */
        .kpi-card {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            border: 1px solid #ddd !important;
        }
    }

    /* الإعدادات العامة للهوية البصرية */
    .statement-container {
        direction: rtl;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #ffffff;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 0 20px rgba(0,0,0,0.05);
    }

    .statement-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-bottom: 2px solid #f1f5f9;
        padding-bottom: 20px;
        margin-bottom: 30px;
    }

    .btn-controls {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .btn-action {
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        font-size: 0.9rem;
    }

    .btn-print { background-color: #f1f5f9; color: #475569; }
    .btn-pdf { background-color: #ef4444; color: white; }
    .btn-whatsapp { background-color: #25d366; color: white; }

    .btn-action:hover { opacity: 0.8; transform: translateY(-2px); color: white; }
    .btn-print:hover { color: #1e293b; }

    /* باقي تنسيقاتك الأصلية كما هي */
    .customer-brand h2 { color: #1e293b; font-weight: 800; margin-bottom: 5px; }
    .customer-info-box { background-color: #f8fafc; padding: 15px 25px; border-radius: 12px; border-right: 4px solid #3b82f6; }
    .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .kpi-card { padding: 20px; border-radius: 12px; color: white; position: relative; overflow: hidden; }
    .kpi-card h4 { font-size: 1.6rem; font-weight: 800; margin: 0; }
    .bg-invoices { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); }
    .bg-collections { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .bg-balance { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .modern-table-wrapper { background: white; border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; margin-bottom: 30px; }
    .modern-table { width: 100%; border-collapse: collapse; }
    .modern-table th { background-color: #f8fafc; padding: 12px 15px; text-align: right; font-size: 0.85rem; color: #64748b; }
    .modern-table td { padding: 12px 15px; border-top: 1px solid #f1f5f9; font-size: 0.95rem; }
    .text-danger-custom { color: #ef4444; font-weight: 700; }
    .text-success-custom { color: #10b981; font-weight: 700; }
    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
    .badge-unpaid { background-color: #fee2e2; color: #991b1b; }
    .badge-paid { background-color: #dcfce7; color: #166534; }
</style>

<div class="statement-container" id="printableArea">
    <div class="statement-header">
        <div class="customer-brand">
            <h2>كشف حساب تفصيلي</h2>
            <div class="customer-info-box">
                <div style="font-weight: 800; font-size: 1.2rem;">@customer.Name</div>
                <div style="color: #64748b;"><i class="fas fa-phone-alt"></i> @customer.Phone</div>
            </div>
        </div>
        <div class="text-start d-print-none">
            <div class="btn-controls">
                <button class="btn-action btn-print" onclick="window.print()">
                    <i class="fas fa-print"></i> طباعة
                </button>
                <button class="btn-action btn-pdf" onclick="generatePDF()">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                @{
                    // تجهيز رسالة الواتساب
                    string message = $"مرحباً سيد {customer.Name}، مرفق لكم كشف الحساب الخاص بكم. الرصيد المستحق: {ViewBag.FinalBalance:N2} ج.م.";
                    string encodedMsg = Uri.EscapeDataString(message);
                    string whatsappUrl = $"https://wa.me/{customer.Phone}?text={encodedMsg}";
                }
                <a href="@whatsappUrl" target="_blank" class="btn-action btn-whatsapp">
                    <i class="fab fa-whatsapp"></i> واتساب
                </a>
            </div>
            <div style="margin-top: 10px; color: #94a3b8; font-size: 0.8rem;">
                تاريخ الاستخراج: @DateTime.Now.ToString("yyyy-MM-dd")
            </div>
        </div>
    </div>

    <div class="kpi-row">
        <div class="kpi-card bg-invoices">
            <h6>إجمالي المديونية</h6>
            <h4>@ViewBag.TotalInvoices.ToString("N2") <small>ج.م</small></h4>
        </div>
        <div class="kpi-card bg-collections">
            <h6>إجمالي المدفوعات</h6>
            <h4>@ViewBag.TotalCollections.ToString("N2") <small>ج.م</small></h4>
        </div>
        <div class="kpi-card bg-balance">
            <h6>الرصيد النهائي</h6>
            <h4>@ViewBag.FinalBalance.ToString("N2") <small>ج.م</small></h4>
        </div>
    </div>

  <h4 class="section-title"><i class="fas fa-receipt text-primary"></i> تفاصيل الفواتير الصادرة</h4>
<div class="modern-table-wrapper">
    <table class="modern-table">
        <thead>
            <tr>
                <th>رقم الفاتورة</th>
                <th>التاريخ</th>
                <th>اسم العملية</th> 
                <th>نوع الصيانة</th> 
                <th>الإجمالي</th>
                <th>المدفوع</th>
                <th>المتبقي</th>
                <th>الحالة</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var i in invoices)
            {
                <tr>
                    <td class="fw-bold">#@i.Id</td>
                    <td class="text-muted">@i.InvoiceDate.ToString("yyyy-MM-dd")</td>
                    
                    <td class="fw-bold text-dark">
                        @(i.OperationName ?? "غير محدد")
                    </td>

                    <td>
                        <span class="badge badge-light border text-secondary" style="font-size: 0.8rem;">
                            <i class="fas fa-cogs fa-sm ml-1"></i> @(i.MaintenanceTypeName ?? "عامة")
                        </span>
                    </td>

                    <td class="fw-bold">@i.Total.ToString("N2")</td>
                    <td class="text-success-custom">@i.Paid.ToString("N2")</td>
                    <td class="@(i.Remaining > 0 ? "text-danger-custom" : "")">@i.Remaining.ToString("N2")</td>
                    <td>
                        <span class="status-badge @(i.Remaining > 0 ? "badge-unpaid" : "badge-paid")">
                            @(i.Remaining > 0 ? "غير مسددة" : "مسددة")
                        </span>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<script>
    function generatePDF() {
        const element = document.getElementById('printableArea');
        const opt = {
            margin:       10,
            filename:     'كشف_حساب_@customer.Name' + '.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // إخفاء الأزرار مؤقتاً قبل التحويل
        document.querySelector('.btn-controls').style.display = 'none';
        
        html2pdf().set(opt).from(element).save().then(() => {
            // إعادة إظهار الأزرار
            document.querySelector('.btn-controls').style.display = 'flex';
        });
    }
</script>